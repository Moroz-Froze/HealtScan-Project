# backend/init_db.py
from sqlalchemy.orm import Session
from database import SessionLocal, engine
from models import Base, Literature
import json

def init_database():
    """Инициализация базы данных с тестовыми данными"""
    
    # Создание всех таблиц
    Base.metadata.create_all(bind=engine)
    
    db = SessionLocal()
    
    try:
        # Проверяем, есть ли уже данные в таблице литературы
        existing_literature = db.query(Literature).first()
        if existing_literature:
            print("База данных уже содержит данные")
            return
        
        # Добавляем тестовую справочную литературу
        literature_data = [
            {
                "title": "Справочник по клинической офтальмологии",
                "description": "Полное руководство по диагностике и лечению заболеваний глаз",
                "content": """
                # Справочник по клинической офтальмологии
                
                ## Введение
                Данный справочник содержит основные сведения о диагностике и лечении заболеваний органов зрения.
                
                ## Основные заболевания
                
                ### Конъюнктивит
                Воспаление конъюнктивы глаза. Может быть бактериальным, вирусным или аллергическим.
                
                **Симптомы:**
                - Покраснение глаз
                - Зуд и жжение
                - Выделения из глаз
                
                **Лечение:**
                - Антибактериальные капли (при бактериальном)
                - Противовирусные препараты (при вирусном)
                - Антигистаминные средства (при аллергическом)
                
                ### Ячмень
                Острое гнойное воспаление волосяного мешочка ресницы.
                
                **Симптомы:**
                - Болезненная припухлость на веке
                - Покраснение
                - Иногда общее недомогание
                
                **Лечение:**
                - Теплые компрессы
                - Антибактериальные мази
                - При необходимости - системные антибиотики
                """,
                "category": "Офтальмология",
                "author": "Д.м.н. Иванов И.И.",
                "tags": json.dumps(["глаза", "зрение", "конъюнктивит", "ячмень"], ensure_ascii=False)
            },
            {
                "title": "Инсектная аллергия: диагностика и лечение",
                "description": "Руководство по диагностике и лечению аллергических реакций на укусы насекомых",
                "content": """
                # Инсектная аллергия: диагностика и лечение
                
                ## Виды реакций на укусы насекомых
                
                ### Местные реакции
                - Покраснение в месте укуса
                - Отек и припухлость
                - Зуд и жжение
                
                ### Системные реакции
                - Крапивница по всему телу
                - Отек лица и горла
                - Затрудненное дыхание
                - Анафилактический шок (требует неотложной помощи)
                
                ## Лечение
                
                ### При местных реакциях:
                - Холодные компрессы
                - Антигистаминные препараты
                - Местные противозудные средства
                
                ### При системных реакциях:
                - Немедленное введение адреналина
                - Системные кортикостероиды
                - Госпитализация для наблюдения
                
                ## Профилактика
                - Избегание мест скопления насекомых
                - Использование репеллентов
                - Ношение закрытой одежды в опасных зонах
                """,
                "category": "Аллергология",
                "author": "К.м.н. Петрова А.В.",
                "tags": json.dumps(["аллергия", "укусы", "насекомые", "анафилаксия"], ensure_ascii=False)
            },
            {
                "title": "Практическое руководство по неотложной помощи при укусах насекомых",
                "description": "Пошаговые инструкции по оказанию первой помощи при укусах различных насекомых",
                "content": """
                # Практическое руководство по неотложной помощи при укусах насекомых
                
                ## Первая помощь при укусах пчел и ос
                
                1. **Удаление жала** (только у пчел):
                   - Не сжимайте жало пальцами
                   - Соскребите жало ногтем или пластиковой картой
                
                2. **Местная обработка**:
                   - Промойте место укуса холодной водой
                   - Приложите лед на 15-20 минут
                   - Нанесите успокаивающий гель или мазь
                
                3. **Наблюдение**:
                   - Следите за развитием аллергической реакции
                   - При появлении системных симптомов - немедленно к врачу
                
                ## Укусы комаров и мошек
                
                1. **Немедленные действия**:
                   - Не расчесывайте место укуса
                   - Промойте холодной водой с мылом
                
                2. **Уменьшение зуда**:
                   - Холодные компрессы
                   - Каламиновый лосьон
                   - Антигистаминные кремы
                
                ## Когда обращаться к врачу
                
                **Немедленно**:
                - Затрудненное дыхание
                - Отек лица, губ, языка
                - Головокружение или потеря сознания
                - Тошнота и рвота
                
                **В ближайшее время**:
                - Сильный отек в месте укуса
                - Признаки инфекции (гной, красные полосы)
                - Температура выше 38°C
                """,
                "category": "Неотложная помощь",
                "author": "Врач скорой помощи Сидоров С.С.",
                "tags": json.dumps(["первая помощь", "укусы", "неотложная помощь", "насекомые"], ensure_ascii=False)
            },
            {
                "title": "Кариес зубов: современные методы диагностики",
                "description": "Обзор современных методов выявления и классификации кариеса",
                "content": """
                # Кариес зубов: современные методы диагностики
                
                ## Что такое кариес
                
                Кариес - это патологический процесс, приводящий к разрушению твердых тканей зуба под воздействием кислот, вырабатываемых бактериями.
                
                ## Стадии развития кариеса
                
                ### 1. Стадия пятна
                - Появление белых или темных пятен на эмали
                - Процесс обратимый при своевременном лечении
                
                ### 2. Поверхностный кариес
                - Разрушение поверхностного слоя эмали
                - Появление шероховатости
                
                ### 3. Средний кариес
                - Поражение дентина
                - Появление полости в зубе
                - Болевые ощущения при приеме сладкой, кислой пищи
                
                ### 4. Глубокий кариес
                - Глубокое поражение дентина
                - Сильные боли
                - Риск осложнений (пульпит, периодонтит)
                
                ## Методы диагностики
                
                ### Визуальный осмотр
                - Осмотр с помощью стоматологического зеркала
                - Оценка цвета и структуры эмали
                
                ### Зондирование
                - Определение плотности тканей
                - Выявление размягченных участков
                
                ### Рентгенография
                - Выявление скрытого кариеса
                - Оценка состояния корней зубов
                
                ### Современные методы
                - Лазерная флуоресценция
                - Транзиллюминация
                - Электрометрия
                
                ## Профилактика
                
                - Регулярная гигиена полости рта
                - Использование фторсодержащих зубных паст
                - Ограничение сладкой пищи
                - Регулярные профилактические осмотры
                """,
                "category": "Стоматология",
                "author": "Стоматолог-терапевт Кузнецова О.М.",
                "tags": json.dumps(["зубы", "кариес", "диагностика", "стоматология"], ensure_ascii=False)
            },
            {
                "title": "Аллергология и иммунология",
                "description": "Основы аллергологии и клинической иммунологии",
                "content": """
                # Аллергология и иммунология
                
                ## Введение в аллергологию
                
                Аллергия - это повышенная чувствительность организма к различным веществам (аллергенам), которые у большинства людей не вызывают патологических реакций.
                
                ## Типы аллергических реакций
                
                ### I тип (немедленный)
                - Развивается в течение минут после контакта с аллергеном
                - Опосредован IgE антителами
                - Примеры: анафилаксия, крапивница, астма
                
                ### II тип (цитотоксический)
                - Разрушение клеток под действием антител
                - Примеры: гемолитическая анемия, тромбоцитопения
                
                ### III тип (иммунокомплексный)
                - Образование иммунных комплексов
                - Примеры: сывороточная болезнь, васкулиты
                
                ### IV тип (замедленный)
                - Развивается через 24-48 часов
                - Опосредован T-лимфоцитами
                - Примеры: контактный дерматит, туберкулиновая проба
                
                ## Основные аллергены
                
                ### Пищевые
                - Молоко, яйца, орехи, рыба, морепродукты
                - Глютен, соя, цитрусовые
                
                ### Респираторные
                - Пыльца растений
                - Домашняя пыль
                - Шерсть животных
                - Плесневые грибы
                
                ### Контактные
                - Металлы (никель, хром)
                - Косметика и парфюмерия
                - Лекарственные препараты
                
                ## Диагностика аллергии
                
                ### Кожные пробы
                - Прик-тесты
                - Внутрикожные пробы
                - Патч-тесты
                
                ### Лабораторная диагностика
                - Определение общего IgE
                - Специфические IgE к аллергенам
                - Тест активации базофилов
                
                ## Лечение аллергии
                
                ### Элиминация аллергенов
                - Избегание контакта с причинным аллергеном
                - Соблюдение элиминационной диеты
                
                ### Медикаментозная терапия
                - Антигистаминные препараты
                - Кортикостероиды
                - Кромоны
                - Антилейкотриеновые препараты
                
                ### Аллерген-специфическая иммунотерапия
                - Постепенное введение возрастающих доз аллергена
                - Формирование толерантности
                - Длительность лечения 3-5 лет
                """,
                "category": "Аллергология",
                "author": "Профессор, д.м.н. Волков В.В.",
                "tags": json.dumps(["аллергия", "иммунология", "диагностика", "лечение"], ensure_ascii=False)
            }
        ]
        
        # Добавляем каждую статью в базу данных
        for data in literature_data:
            literature = Literature(**data)
            db.add(literature)
        
        db.commit()
        print("База данных успешно инициализирована тестовыми данными")
        
    except Exception as e:
        print(f"Ошибка при инициализации базы данных: {e}")
        db.rollback()
    finally:
        db.close()

if __name__ == "__main__":
    init_database()
